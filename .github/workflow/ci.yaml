# ci for product catalog service #


name: product-catalog-service-ci

on:
   pull request:
        branches:
        - main 

jobs:
    build:
        runs-on: ubuntu-latest

        steps:
        - name: checkout code
          uses: actions/checkout@v4
          
        - name: setup Go 1.22
           uses: actions/setup-go@v2
          with:
            go-version: 1.22


        - name: Build 
            run: |
              cd src/product-catalog
              go mod download
              go build -o product-catalog-service main.go
        - name: unit tests
          run: |
            cd src/product-catalog
            go test./...


    code-quality:
    runs-on: ubuntu-latest

    steps:
     - name: checkout code
       uses: actions/checkout@v4

     - name: Run golangci-Lint
        run: 
             go install github.com/golangci-Lint/cmd/golangci-Lint@v1.56.2
             golangci-Lint run src/product-catalog/...



    dockers: 
    - runs-on: ubuntu-latest

     needs: build

     steps:
     - name: checkout code
       uses: actions/checkout@v4           
     

     - name: install dockers
       uses: docker/setup-buildex-action@v1

     - name: Login to docker
       uses: docker/login-action@v3
       with: 

        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_TOKEN }}

     - name: docker push
       uses: docker/build-push-action@v6 
       with: 
          context: src/product-catalog 
          file: Dockerfile
          push: true
          tags: ${{ secrets.DOCKERHUB_USERNAME }}/product-catalog-service:${{github.run_id}} 


     updatek8s: 
     runs-on: ubuntu-latest
      needs: [build, docker, code-quality]

      steps:
     - name: checkout code
       uses: actions/checkout@v4 
       with: 
       token: ${{ secrets.GITHUB_TOKEN }} 

     - name: update tag in kubernetes deployment manifest 
       run: |
            sed -i 's/image: ,*/image: ${{ secrets.DOCKERHUB_USERNAME }}/product-catalog-service:${{github.run_id}}/kambleamitwork/product-catalog-service:
            
    - name: commit and push changes
      run: |
        git config --global user.email "amitkamble9145@gmail.com"
        git config --global user.name  "Amitkamble5521"
        git add kubernetes/product-catalog/deploy.yaml
        git commit -m "[CI]: update product catalog image tag"
        git push origin HEAD:main -f 